<?php
    use Lib\Msg;
?>

<div class="home-overlay"></div>
<section class="page-header">
  <div class="container">
   
  </div>
</section>

<!-- Google map -->
<!--
<div id="overlay">
     <iframe id="map" src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d1247.8738726885501!2d15.57331525829417!3d51.27896227270021!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x470f35cd1daf7d8d%3A0x7c2aec1432fec2ef!2zUHJ6ZW15c8WCb3dhLCBCb2xlc8WCYXdpZWM!5e0!3m2!1spl!2spl!4v1486664148436" width="100%" height="500" frameborder="0" style="border:0" allowfullscreen></iframe>
</div>-->
<style>
    .scrolloff
		{
        pointer-events: none;
    }
</style>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<script>
    $(document).ready(function () {

        $('#map-canvas').addClass('scrolloff');            /* set the mouse events to none when doc is ready */
    
        $('#overlay').on("mousedown",function()						/* when mouse down, set the mouse events free */
				{     
            $('#map-canvas').removeClass('scrolloff');
        });

        $("#map-canvas").mouseleave(function ()						/* becuase the mouse up doesn't work... */
				{          
            $('#map-canvas').addClass('scrolloff');        /* set the pointer events to none when mouse leaves the map area */
                                                          /* or you can do it on some other event */
        });
        
    });
</script>
<!-- Google map -->


<section class="service">
  
  <div class="container">
    <div class="row">
    
    </div>
  </div>



<div class="row">

	<!-- Mapa -->
	<div class="col-md-9">
		<div id="overlay">
			<div id="map-canvas" style="border:1px solid; height:800px; width:100%"></div>
		</div>
	</div>
	<!-- Mapa -->
	
	<!-- Lista itemów na mapie -->
	<div class="col-md-3">
		<div id="ship_list" style="height:600px; overflow:auto;" class="panel-group" id="accordion">
				
		<?php
			$i = 1;
			foreach($this->getItems() as $item)
			{
		?>
		<div class="panel panel-default" id="item" data-itemid="<?php print $item->id ?>">
			<a data-toggle="collapse" data-parent="#accordion" href="#collapse<?php print $i ?>">
			<div class="panel-heading">
				<h2 class="panel-title">
					<?php print $i; ?>
					<?php print $item->name.'('.$item->mmsi.')'; ?>
				</h2>
			</div>
			</a>
			<div id="collapse<?php print $i ?>" class="panel-collapse collapse">
				<div class="panel-body"><?php print $item->lon; ?></div>
				<div class="panel-body"><?php print $item->lat; ?></div>
			</div>
		</div>
		
		<?php
			$i++;
			}
		?>
		</div>
		<!-- Lista itemów na mapie -->
	</div>
	
</div>
  

<script>
    
    var map;
    var infowindow;
		var bounds;
		var markers = [];
	
	
		/* click on item to zoom marker */
		$(document).on("click","#item",function()
		{
			var thisloc = $(this).data("itemid");
			/*alert(thisloc);*/
			
			/* alert(markers.length); */
			for(var i=0; i < markers.length; i++)
			{
				if(markers[i].id == thisloc)
				{
					/* get the latlong */
					map.panTo(markers[i].getPosition());
					infowindow.setContent('<h2>' + markers[i].title + '</h2>' + '<br>' + markers[i].text );
					infowindow.open(map, markers[i]);
				}
		}
	});
    
	function panTo()
	{
		map.panTo(curmarker.position);	
	}
	
    function initMap()
    {
        var mapStyle = [{'featureType': 'administrative', 'elementType': 'labels.text.fill', 'stylers': [{'color': '#444444'}]}, {'featureType': 'landscape', 'elementType': 'all', 'stylers': [{'color': '#f2f2f2'}]}, {'featureType': 'poi', 'elementType': 'all', 'stylers': [{'visibility': 'off'}]}, {'featureType': 'road', 'elementType': 'all', 'stylers': [{'saturation': -100}, {'lightness': 45}]}, {'featureType': 'road.highway', 'elementType': 'all', 'stylers': [{'visibility': 'simplified'}]}, {'featureType': 'road.arterial', 'elementType': 'labels.icon', 'stylers': [{'visibility': 'off'}]}, {'featureType': 'transit', 'elementType': 'all', 'stylers': [{'visibility': 'off'}]}, {'featureType': 'water', 'elementType': 'all', 'stylers': [{'color': '#4f595d'}, {'visibility': 'on'}]}];

        /* Create the map */
        map = new google.maps.Map(document.getElementById('map-canvas'),
        {
            zoom: 5,
            styles: mapStyle,
            center: new google.maps.LatLng(51.264, 15.569)
        });
    }
    
    function initinfoWindow()
    {
        infowindow = new google.maps.InfoWindow();
    }
        
    function createMarker(id,lat, lon, title, text)
    {
        return marker = new google.maps.Marker
				({
					position: new google.maps.LatLng(lat, lon),
					id: id,
					map: map,
					title: title,
					text: text
        });
    }
    
    function createInfoWindowEvent(m)
    {
        google.maps.event.addListener(m, 'click', function()
        {
            infowindow.setContent(m.title + '<br>' + m.text );
            infowindow.open(map, m);
        });
    }

		function createListItem(m)
		{
			var ul = document.getElementById("items");
			var li = document.createElement("li");
			li.innerHTML = m.title;
			ul.appendChild(li);
		}
	
		function fitBounds(m)
		{
			bounds.extend(m.getPosition());
		}
    
	function initPlaces(url)
	{
        
		$.ajax
		({
			type: "POST",
			url: url,
			success: function(html)
			{

				places = JSON.parse(html);
				bounds = new google.maps.LatLngBounds();
				
				for (var i = 0; i < places.length; i++)
				{
					var marker = createMarker(places[i].id,places[i].lat, places[i].lon, places[i].name,places[i].lon +'<br>'+ places[i].lat );
					markers.push(marker);
					fitBounds(marker);
					createInfoWindowEvent(marker);
                                        
					/* nie używamy, robimy listę zwykłym html
					  createListItem(marker); */
				}
				
				addCluster();
				map.fitBounds(bounds);
				
			},
		});
		
	}
		
		function addCluster()
		{
			var markerCluster = new MarkerClusterer(map, markers, {imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'});
		}
    
		function init()
    {
        initMap();
        initinfoWindow();
        initPlaces("ship/shipsJson");
				
			/*alert(places.length); */
       
        
        /*    
         = createMarker(51.2641800,15.5697000,content('Bolesławiec','Opis bolesławca'));
        
        var marker = createMarker(51.2641800,15.6697000,content('Tomaszów','Opis tomaszowa'));
        createInfoWindowEvent(marker);
        */
    }
       
    
</script>

<script type="text/javascript" src="http://maps.google.com/maps/api/js?key=AIzaSyAtyXbZQiMV2BFDdztVuCZPfzN_rijV4_U&callback=init" async defer></script>
<script type="text/javascript" src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>
<!--<script src="../../dist/snazzy-info-window.min.js"></script>-->

<!-- scroll listy statków -->
<script>
	
		$('#ship_list').scroll(function()
		{
			
				console.log($('#ship_list').scrollTop());
				console.log($('#ship_list').height());
				console.log($('#ship_list').scrollBottom());
			/*
				request("#blog-content","page/content/setpage-","<?php print $this->CurrentItem->url_address; ?>") ;
			*/
			
			console.log("scroll");
			if ($(window).scrollTop() + $(window).height() > ($(document).height() - 200))
			{
				/* Reached page bottom. Call the ajax function or any other foo here. 
				request("#blog-content","page/content/setpage-","<?php print $this->CurrentItem->url_address; ?>") ;
				*/
				alert('bottom');
			}
		});
</script>

